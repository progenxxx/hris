import{V as ne,r as c,R as _,j as t,M as oe}from"./app-C_ClQmDY.js";import{A as le}from"./AuthenticatedLayout-3cR_usYW.js";import{S as ie}from"./Sidebar-Bhx-DaaE.js";import{p as ce}from"./papaparse.min-BxKIn3GS.js";import{r as de,u as me}from"./xlsx-vauHSbSi.js";import{A as M,a as R,b as ue}from"./alert-CLB16PDI.js";import{B as $}from"./Button-Du7mhroA.js";import{C as pe,a as he,b as xe,c as fe}from"./card-Cx-sVNbO.js";import{C as O}from"./cloud-upload-B-I6PEQK.js";import{D as ge}from"./download-BQI3-SNa.js";import{C as P}from"./circle-check-Bp0YyD3W.js";import{C as ye}from"./circle-x-CQhehAg2.js";import{F as je}from"./file-spreadsheet-DaU4vyfX.js";import{C as F}from"./circle-alert-xhzyFgGA.js";import{C as be}from"./clock-CtBUUqYK.js";import"./ApplicationLogo-BORf3137.js";import"./Dropdown-CHXQRgIL.js";import"./transition-0ACRCynB.js";import"./search-BDKFcNkb.js";import"./createLucideIcon-D1ADp28Z.js";import"./x-Q1lJB2Tb.js";/* empty css                */import"./users-Dr4YdQlV.js";import"./file-text-DMC5LN9m.js";import"./calendar-B28JSqfz.js";import"./clsx-B-dksMZM.js";const ve=ce,we=()=>t.jsx("div",{className:"animate-spin h-5 w-5",children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),Ke=()=>{var A,T,I;const{auth:H}=ne().props,[u,v]=c.useState(null),[w,L]=c.useState([]),[S,D]=c.useState(!1),[k,d]=c.useState(""),[m,E]=c.useState(null),[p,h]=c.useState(null),[Ne,z]=c.useState(!1),[x,y]=c.useState(!1),V=["employee_no","date","day","in","out","in2","out2","next_day","hours_work"],B={employee_no:["employee_no","employee no","employee no.","employeeno","idno","employee number","id","id no","employee_no."],date:["date"],day:["day"],in:["in","in1","time in","time_in","timein","in time","first in","morning in","IN"],out:["out","out1","time out","time_out","timeout","out time","first out","morning out","OUT"],in2:["in2","second in","break in","break_in","afternoon in","IN"],out2:["out2","second out","break out","break_out","afternoon out","OUT"],next_day:["next day","next_day","nextday","overnight","next","Next day"],hours_work:["hours work","hours_work","work hours","total hours","hours","hours worked","Hours Work"]},U=e=>{if(!e)return"";try{if(typeof e=="number"){const l=new Date(1899,11,30),n=24*60*60*1e3,i=new Date(l.getTime()+e*n),f=i.getFullYear(),g=String(i.getMonth()+1).padStart(2,"0"),C=String(i.getDate()).padStart(2,"0");return`${f}-${g}-${C}`}const r=new Date(e);if(isNaN(r.getTime()))return e;const a=r.getFullYear(),s=String(r.getMonth()+1).padStart(2,"0"),o=String(r.getDate()).padStart(2,"0");return`${a}-${s}-${o}`}catch{return e}},W=e=>{if(!e)return"";try{if(typeof e=="number"){const n=Math.round(e*86400),i=Math.floor(n/3600),f=Math.floor(n%3600/60),g=i>=12?"PM":"AM",C=i%12||12;return`${String(C).padStart(2,"0")}:${String(f).padStart(2,"0")} ${g}`}const r=new Date(`2000-01-01 ${e}`);if(isNaN(r.getTime()))return e;const a=r.getHours(),s=r.getMinutes(),o=a>=12?"PM":"AM",l=a%12||12;return`${String(l).padStart(2,"0")}:${String(s).padStart(2,"0")} ${o}`}catch{return e}},q=e=>{if(e==null||e==="")return"";const r=parseFloat(e);return isNaN(r)?e:r.toFixed(2)},j=e=>e==null?"":String(e).toLowerCase().trim().replace(/\s+/g,"_"),X=e=>{const r=e.map((s,o)=>({header:j(s),index:o})).filter(s=>s.header==="in"),a=e.map((s,o)=>({header:j(s),index:o})).filter(s=>s.header==="out");return r.length===2?{in:r[0].index,in2:r[1].index}:a.length===2?{out:a[0].index,out2:a[1].index}:{}},Y=e=>{const r=j(e);for(const[a,s]of Object.entries(B))if(s.map(j).includes(r))return a;return null},G=e=>{const r={},a=X(e);Object.assign(r,a),e.forEach((o,l)=>{const n=Y(o);n&&!r[n]&&(r[n]=l)});const s=V.filter(o=>r[o]===void 0);return{valid:s.length===0,missingColumns:s,columnIndices:r}},K=(e,r,a)=>{const s=[...e];return Object.entries(a).forEach(([o,l])=>{if(l>=0&&l<e.length){const n=e[l];switch(o){case"date":s[l]=U(n);break;case"in":case"out":case"in2":case"out2":case"next_day":s[l]=W(n);break;case"hours_work":s[l]=q(n);break}}}),s},Z=e=>{if(!["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","text/csv"].includes(e.type)&&!e.name.endsWith(".csv")&&!e.name.endsWith(".xlsx")&&!e.name.endsWith(".xls"))throw new Error("Please upload only Excel or CSV files (.xlsx, .xls, .csv)");if(e.size>10*1024*1024)throw new Error("File size should not exceed 10MB");return!0},b=c.useCallback(async e=>{if(!e)return;try{Z(e)}catch(a){d(a.message),h("error");return}v(e),d(""),h("validating");const r=new FileReader;r.onload=async a=>{try{let s;if(e.name.endsWith(".csv")){const n=a.target.result;s=ve.parse(n,{header:!1,skipEmptyLines:!0}).data}else{const n=new Uint8Array(a.target.result),i=de(n,{type:"array"}),f=i.SheetNames[0],g=i.Sheets[f];s=me.sheet_to_json(g,{header:1})}if(!s[0]||s[0].length===0)throw new Error("File appears to be empty");const o=G(s[0]);if(!o.valid){d(`Missing required columns: ${o.missingColumns.join(", ")}`),h("error"),v(null);return}const l=s.filter(n=>n.some(i=>i!=="")).slice(0,6).map((n,i)=>i===0?n:K(n,s[0],o.columnIndices));L(l),h("success")}catch(s){console.error("File reading error:",s),d("Error reading file. Please make sure it's a valid Excel or CSV file."),h("error"),v(null)}},e.name.endsWith(".csv")?r.readAsText(e):r.readAsArrayBuffer(e)},[]),J=c.useCallback(async e=>{const r=e.target.files[0];await b(r)},[b]),N=_.useRef(null),Q=c.useCallback(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="copy",y(!0)},[]),ee=c.useCallback(e=>{e.preventDefault(),e.stopPropagation(),y(!0)},[]),te=c.useCallback(e=>{e.preventDefault(),e.stopPropagation();const r=e.currentTarget.getBoundingClientRect();(e.clientX<r.left||e.clientX>r.right||e.clientY<r.top||e.clientY>r.bottom)&&y(!1)},[]),re=c.useCallback(async e=>{e.preventDefault(),e.stopPropagation(),y(!1);const r=e.dataTransfer.files;r&&r.length>0&&await b(r[0])},[b]);_.useEffect(()=>{const e=a=>{var s;(s=N.current)!=null&&s.contains(a.target)||a.preventDefault()},r=a=>{var s;(s=N.current)!=null&&s.contains(a.target)||a.preventDefault()};return document.addEventListener("dragover",e),document.addEventListener("drop",r),()=>{document.removeEventListener("dragover",e),document.removeEventListener("drop",r)}},[]);const se=async()=>{var r;if(!u){d("Please select a file first");return}D(!0),d(""),E(null);const e=new FormData;e.append("file",u);try{const a=await fetch("/attendance/import",{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},credentials:"same-origin",body:e}),s=await a.json();if(!a.ok)throw new Error(s.error||s.message||"Import failed");E(s),((r=s.failures)==null?void 0:r.length)===0&&z(!0)}catch(a){console.error("Import error:",a),d(a.message||"Import failed. Please try again.")}finally{D(!1)}},ae=async()=>{try{window.location.href="/attendance/template/download"}catch(e){console.error("Download error:",e),d("Failed to download template: "+e.message)}};return t.jsxs(le,{user:H.user,children:[t.jsx(oe,{title:"Import Attendance Records"}),t.jsxs("div",{className:"flex min-h-screen bg-gray-50/50",children:[t.jsx(ie,{}),t.jsx("div",{className:"flex-1 p-8",children:t.jsxs("div",{className:"max-w-7xl mx-auto",children:[t.jsx("div",{className:"flex items-center justify-between mb-8",children:t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-1",children:"Import Attendance Records"}),t.jsx("p",{className:"text-gray-600",children:"Bulk import employee attendance data using our Excel template."})]})}),t.jsxs(pe,{className:"max-w-4xl mx-auto",children:[x&&t.jsx("div",{className:"fixed inset-0 z-50 bg-blue-500 bg-opacity-20 flex items-center justify-center",style:{pointerEvents:"none"},children:t.jsx("div",{className:"bg-white p-8 rounded-lg shadow-lg border-2 border-blue-400 border-dashed",children:t.jsxs("div",{className:"text-center",children:[t.jsx(O,{className:"h-16 w-16 text-blue-500 mx-auto mb-4"}),t.jsx("p",{className:"text-xl font-semibold text-blue-600",children:"Drop your Excel file here"})]})})}),t.jsxs(he,{children:[t.jsx(xe,{children:"Import Attendance"}),t.jsx("p",{className:"text-gray-600",children:"Upload your Excel file containing attendance records with the format matching the sample template."})]}),t.jsx(fe,{children:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[t.jsx("h3",{className:"text-sm font-medium text-blue-800 mb-2",children:"Required Columns:"}),t.jsx("div",{className:"grid grid-cols-3 gap-2",children:["employee no","date","day","in","out","in2","out2","next day","hours work"].map(e=>t.jsxs("div",{className:"flex items-center text-sm text-blue-700",children:[t.jsx("div",{className:"w-2 h-2 bg-blue-400 rounded-full mr-2"}),e]},e))})]}),t.jsxs($,{onClick:ae,variant:"outline",className:"w-full",children:[t.jsx(ge,{className:"w-4 h-4 mr-2"}),"Download Attendance Import Template"]}),t.jsxs("div",{ref:N,className:`border-2 border-dashed rounded-lg p-8 transition-colors relative ${x?"border-blue-400 bg-blue-50":p==="success"?"border-green-300 bg-green-50":p==="error"?"border-red-300 bg-red-50":"border-gray-300"}`,onDragEnter:ee,onDragOver:Q,onDragLeave:te,onDrop:re,style:{minHeight:"200px",position:"relative"},children:[t.jsx("input",{type:"file",onChange:J,className:"hidden",id:"file-upload",accept:".xlsx,.xls,.csv"}),t.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer flex flex-col items-center",children:[p==="success"?t.jsx(P,{className:"h-12 w-12 text-green-500 mb-4"}):p==="error"?t.jsx(ye,{className:"h-12 w-12 text-red-500 mb-4"}):t.jsx(O,{className:`h-12 w-12 mb-4 ${x?"text-blue-500":"text-gray-400"}`}),t.jsx("span",{className:`text-center ${x?"text-blue-600":"text-gray-600"}`,children:u?t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(je,{className:"h-5 w-5"}),u.name]}):x?"Drop your file here":"Drop your Excel file here or click to browse"}),!u&&t.jsx("span",{className:"text-sm text-gray-500 mt-2",children:"Supports .xlsx, .xls, and .csv files (max 10MB)"})]})]}),w.length>0&&t.jsx("div",{className:"border rounded-lg overflow-hidden",children:t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsx("tr",{children:w[0].map((e,r)=>t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e},r))})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:w.slice(1).map((e,r)=>t.jsx("tr",{children:e.map((a,s)=>t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:a},s))},r))})]})})}),k&&t.jsxs(M,{variant:"destructive",children:[t.jsx(F,{className:"h-4 w-4"}),t.jsx(R,{children:k})]}),m&&t.jsxs(M,{variant:((A=m.failures)==null?void 0:A.length)===0?"default":"warning",children:[t.jsx(ue,{children:((T=m.failures)==null?void 0:T.length)===0?"Success!":"Import Complete"}),t.jsx(R,{children:t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(P,{className:"h-4 w-4 text-green-500"}),t.jsx("span",{className:"font-medium",children:m.message})]}),m.successful>0&&t.jsxs("div",{className:"text-sm text-green-600",children:["Total records processed: ",m.total_processed]}),((I=m.failures)==null?void 0:I.length)>0&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[t.jsx(F,{className:"h-4 w-4 text-amber-500"}),t.jsx("span",{className:"font-medium",children:"Failed Imports"})]}),t.jsx("div",{className:"mt-2 max-h-40 overflow-y-auto border-l-2 border-amber-200 pl-4",children:m.failures.map((e,r)=>t.jsxs("div",{className:"text-sm text-amber-600 mb-1",children:["Row ",e.row,": ",e.errors.join(", ")]},r))})]})]})})]}),t.jsx($,{onClick:se,disabled:!u||S||p!=="success",className:"w-full",children:S?t.jsxs(t.Fragment,{children:[t.jsx(we,{}),t.jsx("span",{className:"ml-2",children:"Importing..."})]}):t.jsxs(t.Fragment,{children:[t.jsx(be,{className:"w-4 h-4 mr-2"}),"Upload and Import Attendance"]})})]})})]})]})})]})]})};export{Ke as default};
