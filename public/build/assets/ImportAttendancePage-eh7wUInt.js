import{a as K,r as m,j as e,H as Y}from"./app-D-TNKEQL.js";import{A as G}from"./AuthenticatedLayout-PCqsYVxf.js";import{S as J}from"./Sidebar-Cg7Kwp5t.js";import{A as R,b as E,a as T}from"./alert-ttcl-5kV.js";import{B as $}from"./Button-SjHtsDzU.js";import{C as Q,a as Z,b as ee,c as te}from"./card-qhIlbjIo.js";import{r as se,u as re}from"./xlsx-BBWTpfDg.js";import{D as ae}from"./download-Dnq6PCPG.js";import{C as I}from"./circle-check-0ZaRqU1Q.js";import{C as oe}from"./circle-x-Ty60vMKt.js";import{C as ne}from"./cloud-upload-BoROQ1o2.js";import{F as le}from"./file-spreadsheet-D6j8h06U.js";import{C as L}from"./circle-alert-DRTaAOqF.js";import{C as ie}from"./clock-D8g538AG.js";import"./ApplicationLogo-Cn-MbvX-.js";import"./Dropdown-BOoMuW7P.js";import"./transition-DeCEAfJ2.js";import"./search-DZDiwkir.js";import"./createLucideIcon-DEWnkTLV.js";import"./x-fQrOvEob.js";/* empty css                */import"./users-Cw0U-ZsC.js";import"./file-text-QjoOwKBJ.js";import"./calendar-DhTYrr3L.js";import"./clsx-B-dksMZM.js";const ce=()=>e.jsx("div",{className:"animate-spin h-5 w-5",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),Me=()=>{var A,F,D;const{auth:M}=K().props,[x,j]=m.useState(null),[w,H]=m.useState([]),[b,v]=m.useState(!1),[S,o]=m.useState(""),[i,C]=m.useState(null),[y,p]=m.useState(null),[de,P]=m.useState(!1),k=["employee_no","date","day","in1","out1","in2","out2","nextday","hours_work"],U=t=>{if(!t)return"";try{if(typeof t=="number"){const n=new Date(1899,11,30),u=1440*60*1e3,d=new Date(n.getTime()+t*u),f=d.getFullYear(),l=String(d.getMonth()+1).padStart(2,"0"),h=String(d.getDate()).padStart(2,"0");return`${f}-${l}-${h}`}const s=new Date(t);if(isNaN(s.getTime()))return t;const r=s.getFullYear(),a=String(s.getMonth()+1).padStart(2,"0"),c=String(s.getDate()).padStart(2,"0");return`${r}-${a}-${c}`}catch{return t}},q=t=>{if(!t)return"";try{if(typeof t=="number"){const u=Math.round(t*86400),d=Math.floor(u/3600),f=Math.floor(u%3600/60),l=d>=12?"pm":"am",h=d%12||12;return`${String(h).padStart(2,"0")}:${String(f).padStart(2,"0")} ${l}`}const s=new Date(`2000-01-01 ${t}`);if(isNaN(s.getTime()))return t;const r=s.getHours(),a=s.getMinutes(),c=r>=12?"pm":"am",n=r%12||12;return`${String(n).padStart(2,"0")}:${String(a).padStart(2,"0")} ${c}`}catch{return t}},_=t=>{if(t==null||t==="")return"";const s=parseFloat(t);return isNaN(s)?t:s.toFixed(2)},X=t=>{const s=k.filter(r=>!t.map(a=>a.toLowerCase()).includes(r.toLowerCase()));return{valid:s.length===0,missingColumns:s}},B=(t,s)=>t.map((r,a)=>{var n;const c=(n=s[a])==null?void 0:n.toLowerCase();if(!c)return r;switch(c){case"date":return U(r);case"in1":case"out1":case"in2":case"out2":case"nextday":return q(r);case"hours_work":return _(r);default:return r}}),O=m.useCallback(async t=>{const s=t.target.files[0];if(!s)return;if(!["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel"].includes(s.type)){o("Please upload only Excel files (.xlsx or .xls)"),p("error");return}if(s.size>10*1024*1024){o("File size should not exceed 10MB"),p("error");return}j(s),o(""),p("validating");const a=new FileReader;a.onload=async c=>{try{const n=new Uint8Array(c.target.result),u=se(n,{type:"array"}),d=u.SheetNames[0],f=u.Sheets[d],l=re.sheet_to_json(f,{header:1});if(!l[0]||l[0].length===0)throw new Error("File appears to be empty");const h=X(l[0]);if(!h.valid){o(`Missing required columns: ${h.missingColumns.join(", ")}`),p("error"),j(null);return}const W=l.filter(g=>g.some(N=>N!=="")).slice(0,6).map((g,N)=>N===0?g:B(g,l[0]));H(W),p("success")}catch{o("Error reading file. Please make sure it's a valid Excel file."),p("error"),j(null)}},a.readAsArrayBuffer(s)},[]),z=async()=>{var s;if(!x){o("Please select a file first");return}v(!0),o(""),C(null);const t=new FormData;t.append("file",x);try{const r=await fetch("/attendance/import",{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},credentials:"same-origin",body:t}),a=await r.json();if(!r.ok)throw new Error(a.error||a.message||"Import failed");C(a),((s=a.failures)==null?void 0:s.length)===0&&P(!0)}catch(r){console.error("Import error:",r),o(r.message||"Import failed. Please try again.")}finally{v(!1)}},V=async()=>{try{const t=await fetch("/attendance/template/download",{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},credentials:"same-origin"});if(!t.ok)throw new Error("Failed to download template");const s=await t.blob(),r=window.URL.createObjectURL(s),a=document.createElement("a");a.href=r,a.download="attendance_import_template.xlsx",document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(r)}catch(t){console.error("Download error:",t),o("Failed to download template. Please try again later.")}};return e.jsxs(G,{user:M.user,children:[e.jsx(Y,{title:"Import Attendance Records"}),e.jsxs("div",{className:"flex min-h-screen bg-gray-50/50",children:[e.jsx(J,{}),e.jsx("div",{className:"flex-1 p-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("div",{className:"flex items-center justify-between mb-8",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-1",children:"Import Attendance Records"}),e.jsx("p",{className:"text-gray-600",children:"Bulk import employee attendance data using our Excel template."})]})}),e.jsxs(Q,{className:"max-w-4xl mx-auto",children:[e.jsxs(Z,{children:[e.jsx(ee,{children:"Import Attendance"}),e.jsx("p",{className:"text-gray-600",children:"Upload your Excel file containing attendance records with employee numbers, dates, and time entries."})]}),e.jsx(te,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-blue-800 mb-2",children:"Required Columns:"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:k.map(t=>e.jsxs("div",{className:"flex items-center text-sm text-blue-700",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-400 rounded-full mr-2"}),t]},t))})]}),e.jsxs($,{onClick:V,variant:"outline",className:"w-full",children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"Download Attendance Import Template"]}),e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-8",children:[e.jsx("input",{type:"file",onChange:O,className:"hidden",id:"file-upload",accept:".xlsx,.xls"}),e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer flex flex-col items-center",children:[y==="success"?e.jsx(I,{className:"h-12 w-12 text-green-500 mb-4"}):y==="error"?e.jsx(oe,{className:"h-12 w-12 text-red-500 mb-4"}):e.jsx(ne,{className:"h-12 w-12 text-gray-400 mb-4"}),e.jsx("span",{className:"text-gray-600 text-center",children:x?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-5 w-5"}),x.name]}):"Drop your Excel file here or click to browse"})]})]}),w.length>0&&e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsx("tr",{children:w[0].map((t,s)=>e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:t},s))})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:w.slice(1).map((t,s)=>e.jsx("tr",{children:t.map((r,a)=>e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:r},a))},s))})]})})}),S&&e.jsxs(R,{variant:"destructive",children:[e.jsx(L,{className:"h-4 w-4"}),e.jsx(E,{children:"Error"}),e.jsx(T,{children:S})]}),i&&e.jsxs(R,{variant:((A=i.failures)==null?void 0:A.length)===0?"success":"warning",children:[e.jsx(E,{children:((F=i.failures)==null?void 0:F.length)===0?"Success!":"Import Complete"}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium",children:i.message})]}),i.successful>0&&e.jsxs("div",{className:"text-sm text-green-600",children:["Total records processed: ",i.total_processed]}),((D=i.failures)==null?void 0:D.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx(L,{className:"h-4 w-4 text-amber-500"}),e.jsx("span",{className:"font-medium",children:"Failed Imports"})]}),e.jsx("div",{className:"mt-2 max-h-40 overflow-y-auto border-l-2 border-amber-200 pl-4",children:i.failures.map((t,s)=>e.jsxs("div",{className:"text-sm text-amber-600 mb-1",children:["Row ",t.row,": ",t.errors.join(", ")]},s))})]})]})})]}),e.jsx($,{onClick:z,disabled:!x||b||y!=="success",className:"w-full",children:b?e.jsxs(e.Fragment,{children:[e.jsx(ce,{}),e.jsx("span",{className:"ml-2",children:"Importing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Upload and Import Attendance"]})})]})})]})]})})]})]})};export{Me as default};
