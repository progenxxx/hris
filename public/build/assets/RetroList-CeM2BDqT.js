import{r as p,j as t,b as P}from"./app-D-TNKEQL.js";import pe from"./RetroStatusBadge-DrELLyOl.js";import xe from"./RetroDetailModal-CUdQtRkh.js";import fe from"./RetroBulkActionModal-p6kRdgeT.js";import he from"./RetroForceApproveButton-CwH3GKSE.js";import{y as j}from"./index-D8OgU6sH.js";import{L as _}from"./loader-circle-D5iasq1K.js";import{D as ge}from"./download-Dnq6PCPG.js";import{S as ye}from"./search-DZDiwkir.js";import{X as je}from"./x-fQrOvEob.js";import{f as we}from"./format-Bw_hER4B.js";import"./dollar-sign-Boh72rKp.js";import"./createLucideIcon-DEWnkTLV.js";import"./user-DhodrGY1.js";import"./calendar-DhTYrr3L.js";import"./clock-D8g538AG.js";import"./circle-check-big-BKozuvyq.js";import"./file-text-QjoOwKBJ.js";import"./circle-x-Ty60vMKt.js";import"./zap-1mqeF5Zv.js";import"./clsx-B-dksMZM.js";const He=({retros:N,onStatusUpdate:O,onDelete:be,userRoles:x={},processing:o=!1})=>{const[R,q]=p.useState(null),[K,B]=p.useState(!1),[g,$]=p.useState(""),[S,Q]=p.useState(N||[]),[w,C]=p.useState(N||[]),[c,h]=p.useState(!1),[k,E]=p.useState(null),[L,v]=p.useState(null),[U,H]=p.useState(!1),[y,V]=p.useState(""),[d,Y]=p.useState({from:"",to:""}),[f,D]=p.useState([]),[Z,z]=p.useState(!1),[F,W]=p.useState(!1);p.useEffect(()=>{N&&(C(N),b(N,g,y,d))},[N]);const b=(e,s,l,n)=>{let i=[...e];if(s&&(i=i.filter(r=>r.status===s)),l){const r=l.toLowerCase();i=i.filter(a=>a.employee&&(a.employee.Fname&&a.employee.Fname.toLowerCase().includes(r)||a.employee.Lname&&a.employee.Lname.toLowerCase().includes(r))||a.employee&&a.employee.idno&&a.employee.idno.toString().includes(r)||a.employee&&a.employee.Department&&a.employee.Department.toLowerCase().includes(r)||a.reason&&a.reason.toLowerCase().includes(r)||a.retro_type&&a.retro_type.toLowerCase().includes(r))}return n.from&&n.to?i=i.filter(r=>{if(!r.retro_date)return!1;const a=new Date(r.retro_date),m=new Date(n.from),u=new Date(n.to);return u.setHours(23,59,59),a>=m&&a<=u}):n.from?i=i.filter(r=>{if(!r.retro_date)return!1;const a=new Date(r.retro_date),m=new Date(n.from);return a>=m}):n.to&&(i=i.filter(r=>{if(!r.retro_date)return!1;const a=new Date(r.retro_date),m=new Date(n.to);return m.setHours(23,59,59),a<=m})),Q(i),i},ee=e=>{if(o||c)return;const s=e.target.value;$(s),b(w,s,y,d)},te=e=>{if(o||c)return;const s=e.target.value;V(s),b(w,g,s,d)},X=(e,s)=>{if(o||c)return;const l={...d,[e]:s};Y(l),b(w,g,y,l)},se=()=>{o||c||($(""),V(""),Y({from:"",to:""}),b(w,"","",{from:"",to:""}))},ae=e=>{o||c||(q(e),B(!0))},M=()=>{B(!1),q(null)},re=(e,s)=>{if(v(e),h(!0),typeof O=="function")try{const l=O(e,s);l&&typeof l.then=="function"?l.then(()=>{v(null),h(!1),M()}).catch(n=>{console.error("Error updating status:",n),j.error("Error: Unable to update status. Please try again."),v(null),h(!1)}):(v(null),h(!1),M())}catch(l){console.error("Error updating status:",l),j.error("Error: Unable to update status. Please refresh the page and try again."),v(null),h(!1)}else console.error("onStatusUpdate is not a function"),j.error("Error: Unable to update status. Please refresh the page and try again."),v(null),h(!1)},ne=e=>{if(!e||isNaN(e)||e<=0){console.error("Delete failed: Invalid ID provided",e),j.error("Error: Invalid retro request ID");return}if(confirm("Are you sure you want to delete this retro request?")){E(e),h(!0),console.log("Attempting to delete retro with ID:",e);const s=`/retro/${e}/delete`;console.log("Delete URL:",s),P.post(s,{},{preserveScroll:!0,onSuccess:l=>{console.log("Delete successful for ID:",e),j.success("Retro request deleted successfully");const n=w.filter(i=>i.id!==e);C(n),b(n,g,y,d),f.includes(e)&&D(i=>i.filter(r=>r!==e)),E(null),h(!1)},onError:l=>{console.error("POST Delete failed, trying direct DELETE:",l);const n=`/retro/${e}`;console.log("Trying direct DELETE to:",n),P.delete(n,{preserveScroll:!0,onSuccess:i=>{console.log("Direct DELETE successful for ID:",e),j.success("Retro request deleted successfully");const r=w.filter(a=>a.id!==e);C(r),b(r,g,y,d),f.includes(e)&&D(a=>a.filter(m=>m!==e)),E(null),h(!1)},onError:i=>{console.error("Both POST and DELETE methods failed:",i);let r="Failed to delete retro request";i&&typeof i=="object"&&(r+=": "+(Object.values(i).join(", ")||"Unknown error")),j.error(r),E(null),h(!1)}})}})}},le=e=>{try{return we(new Date(e),"yyyy-MM-dd")}catch(s){return console.error("Error formatting date:",s),"Invalid date"}},oe=()=>{if(!(o||c))if(W(!F),F)D([]);else{let e=[];(x.isDepartmentManager||x.isHrdManager||x.isSuperAdmin)&&(e=S.filter(s=>s.status==="pending").map(s=>s.id)),D(e)}},ie=e=>{o||c||D(s=>s.includes(e)?s.filter(l=>l!==e):[...s,e])},ce=()=>{if(f.length===0){alert("Please select at least one retro request");return}o||c||z(!0)},G=()=>{z(!1)},de=(e,s)=>{h(!0);const l={retro_ids:f,status:e,remarks:s};P.post(route("retro.bulkUpdateStatus"),l,{preserveScroll:!0,onSuccess:n=>{var r,a;const i=w.map(m=>{var u,I;return f.includes(m.id)?{...m,status:e,remarks:s,approved_at:new Date().toISOString(),approver:(I=(u=n.props)==null?void 0:u.auth)!=null&&I.user?{id:n.props.auth.user.id,name:n.props.auth.user.name}:null}:m});C(i),b(i,g,y,d),(a=(r=n.props)==null?void 0:r.flash)!=null&&a.message?j.success(n.props.flash.message):j.success(`Successfully ${e} ${f.length} retro requests`),D([]),W(!1),G(),h(!1)},onError:n=>{console.error("Error during bulk update:",n),j.error("Failed to update retro requests: "+((n==null?void 0:n.message)||"Unknown error")),h(!1)}})},me=()=>{if(o||c||U)return;H(!0);const e=new URLSearchParams;g&&e.append("status",g),y&&e.append("search",y),d.from&&e.append("from_date",d.from),d.to&&e.append("to_date",d.to);const s=`/retro/export?${e.toString()}`,l=document.createElement("a");l.href=s,l.target="_blank",document.body.appendChild(l),l.click(),document.body.removeChild(l),setTimeout(()=>{H(!1)},2e3)},J=e=>{var s,l;return x.isSuperAdmin||x.isHrdManager?e.status==="pending":x.isDepartmentManager?e.status==="pending"&&((l=x.managedDepartments)==null?void 0:l.includes((s=e.employee)==null?void 0:s.Department)):!1},A=S.filter(e=>J(e)).length,T=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"PHP"}).format(e),ue=()=>c||o?t.jsxs(t.Fragment,{children:[t.jsx(_,{className:"h-4 w-4 mr-1 animate-spin"}),"Processing..."]}):`Bulk Action (${f.length})`;return t.jsxs("div",{className:"bg-white shadow-md rounded-lg overflow-hidden flex flex-col h-[62vh] relative",children:[(o||c)&&t.jsx("div",{className:"absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40",children:t.jsxs("div",{className:"text-center",children:[t.jsx(_,{className:"h-8 w-8 animate-spin mx-auto mb-2 text-indigo-600"}),t.jsx("p",{className:"text-sm text-gray-600",children:o?"Processing retro requests...":"Updating data..."})]})}),t.jsxs("div",{className:"p-4 border-b",children:[t.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0",children:[t.jsx("h3",{className:"text-lg font-semibold",children:"Retro Requests"}),t.jsxs("div",{className:"flex flex-wrap gap-2 w-full md:w-auto",children:[t.jsx("button",{onClick:me,className:"px-3 py-1 bg-green-600 text-white rounded-md text-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200",title:"Export to Excel",disabled:U||o||c,children:U?t.jsxs(t.Fragment,{children:[t.jsx(_,{className:"h-4 w-4 mr-1 animate-spin"}),"Exporting..."]}):t.jsxs(t.Fragment,{children:[t.jsx(ge,{className:"h-4 w-4 mr-1"}),"Export"]})}),x.isSuperAdmin&&t.jsx(he,{selectedIds:f,disabled:o||c}),f.length>0&&t.jsx("button",{onClick:ce,className:"px-3 py-1 bg-indigo-600 text-white rounded-md text-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex items-center disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200",disabled:o||c,children:ue()}),t.jsx("div",{className:"flex items-center",children:t.jsxs("select",{id:"statusFilter",className:"rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50",value:g,onChange:ee,disabled:o||c,children:[t.jsx("option",{value:"",children:"All Statuses"}),t.jsx("option",{value:"pending",children:"Pending"}),t.jsx("option",{value:"approved",children:"Approved"}),t.jsx("option",{value:"rejected",children:"Rejected"})]})})]})]}),t.jsxs("div",{className:"mt-4 flex flex-col md:flex-row gap-3",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:t.jsx(ye,{className:"h-4 w-4 text-gray-400"})}),t.jsx("input",{type:"text",placeholder:"Search by name, ID, department, reason, or type",className:"pl-10 w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50",value:y,onChange:te,disabled:o||c})]}),t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx("label",{htmlFor:"fromDate",className:"mr-2 text-sm font-medium text-gray-700",children:"From:"}),t.jsx("input",{id:"fromDate",type:"date",className:"rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50",value:d.from,onChange:e=>X("from",e.target.value),disabled:o||c})]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("label",{htmlFor:"toDate",className:"mr-2 text-sm font-medium text-gray-700",children:"To:"}),t.jsx("input",{id:"toDate",type:"date",className:"rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50",value:d.to,onChange:e=>X("to",e.target.value),disabled:o||c})]}),(g||y||d.from||d.to)&&t.jsxs("button",{onClick:se,className:"px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md text-sm flex items-center disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200",title:"Clear all filters",disabled:o||c,children:[t.jsx(je,{className:"h-4 w-4 mr-1"}),"Clear"]})]})]})]}),t.jsx("div",{className:"overflow-auto flex-grow",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[t.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:t.jsxs("tr",{children:[A>0&&t.jsx("th",{scope:"col",className:"px-4 py-3 w-10",children:t.jsx("input",{type:"checkbox",className:"rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50",checked:F&&f.length===A,onChange:oe,disabled:o||c})}),t.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Employee"}),t.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Type"}),t.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Retro Date"}),t.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Time & Rate"}),t.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Amount"}),t.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),t.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Approved By"}),t.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:S.length===0?t.jsx("tr",{children:t.jsx("td",{colSpan:A>0?"9":"8",className:"px-6 py-4 text-center text-sm text-gray-500",children:o||c?"Loading retro requests...":"No retro records found"})}):S.map(e=>{var n,i,r,a,m;const s=u=>({DAYS:"Regular Days",OVERTIME:"Overtime Hours",SLVL:"Sick/Vacation Leave",HOLIDAY:"Holiday Work",RD_OT:"Rest Day Overtime"})[u]||(u==null?void 0:u.charAt(0).toUpperCase())+(u==null?void 0:u.slice(1)),l=u=>({DAYS:"Days",OVERTIME:"Hours",SLVL:"Days",HOLIDAY:"Hours",RD_OT:"Hours"})[u]||"Units";return t.jsxs("tr",{className:`hover:bg-gray-50 transition-colors duration-200 ${k===e.id||L===e.id?"opacity-50":""}`,children:[A>0&&t.jsx("td",{className:"px-4 py-4",children:J(e)&&t.jsx("input",{type:"checkbox",className:"rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50",checked:f.includes(e.id),onChange:()=>ie(e.id),disabled:o||c||k===e.id||L===e.id})}),t.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[t.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.employee?`${e.employee.Lname}, ${e.employee.Fname}`:"Unknown employee"}),t.jsx("div",{className:"text-sm text-gray-500",children:((n=e.employee)==null?void 0:n.idno)||"N/A"}),t.jsx("div",{className:"text-xs text-gray-400",children:((i=e.employee)==null?void 0:i.Department)||"No Dept"})]}),t.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[t.jsx("div",{className:"text-sm text-gray-900",children:s(e.retro_type)}),t.jsx("div",{className:"text-sm text-gray-500",children:e.adjustment_type?e.adjustment_type.charAt(0).toUpperCase()+e.adjustment_type.slice(1):""})]}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsx("div",{className:"text-sm text-gray-900",children:e.retro_date?le(e.retro_date):"N/A"})}),t.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[t.jsx("div",{className:"text-sm text-gray-900",children:e.hours_days?`${e.hours_days} ${(r=l(e.retro_type))==null?void 0:r.toLowerCase()}`:"N/A"}),t.jsx("div",{className:"text-sm text-gray-500",children:e.multiplier_rate?`${e.multiplier_rate}x rate`:"N/A"}),t.jsx("div",{className:"text-xs text-gray-400",children:e.base_rate?`Base: ${T(e.base_rate)}`:""})]}),t.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[t.jsx("div",{className:"text-sm font-medium text-gray-900",children:T(e.computed_amount||e.requested_total_amount||0)}),e.original_total_amount!==void 0&&e.original_total_amount>0&&t.jsxs("div",{className:"text-sm text-gray-500",children:["Original: ",T(e.original_total_amount)]})]}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsx(pe,{status:e.status})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.approver?e.approver.name:"N/A"}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:t.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[t.jsx("button",{onClick:()=>ae(e),className:"text-indigo-600 hover:text-indigo-900 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200",disabled:o||c||L===e.id,children:"View"}),e.status==="pending"&&(x.isSuperAdmin||e.employee_id===x.employeeId||x.isDepartmentManager&&((m=x.managedDepartments)==null?void 0:m.includes((a=e.employee)==null?void 0:a.Department)))&&t.jsx("button",{onClick:()=>ne(e.id),className:"text-red-600 hover:text-red-900 disabled:opacity-50 disabled:cursor-not-allowed flex items-center transition-colors duration-200",disabled:o||c||k===e.id,children:k===e.id?t.jsxs(t.Fragment,{children:[t.jsx(_,{className:"h-3 w-3 mr-1 animate-spin"}),"Deleting..."]}):"Delete"})]})})]},e.id)})})]})}),t.jsx("div",{className:"px-4 py-3 bg-gray-50 border-t text-sm text-gray-600",children:t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("div",{children:["Showing ",S.length," of ",w.length," retro requests",f.length>0&&t.jsxs("span",{className:"ml-4 text-indigo-600 font-medium",children:[f.length," selected"]})]}),(o||c)&&t.jsxs("div",{className:"flex items-center text-indigo-600",children:[t.jsx(_,{className:"h-4 w-4 animate-spin mr-1"}),t.jsx("span",{className:"text-xs",children:o?"Processing...":"Updating..."})]})]})}),K&&R&&t.jsx(xe,{retro:R,onClose:M,onStatusUpdate:re,userRoles:x,viewOnly:o||c,processing:L===R.id}),Z&&t.jsx(fe,{selectedCount:f.length,onClose:G,onSubmit:de,userRoles:x})]})};export{He as default};
